<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Deutsche Artikel üben</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 500px;
        margin: auto;
        padding: 1em;
      }
      button {
        margin: 0.3em;
        padding: 0.6em 1.2em;
        font-size: 1rem;
      }
      button.correct {
        background-color: #4caf50;
        color: white;
      }
      button.wrong {
        background-color: #f44336;
        color: white;
      }
      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      #ergebnis {
        margin-top: 1em;
        font-weight: bold;
      }
      #modal,
      #falschModal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        justify-content: center;
        align-items: center;
      }
      #modalContent,
      #falschModalContent {
        background: white;
        padding: 1em;
        max-width: 90%;
        max-height: 80%;
        overflow-y: auto;
        border-radius: 8px;
        box-shadow: 0 0 10px #00000088;
      }
      #falschListe {
        max-height: 300px;
        overflow-y: auto;
        margin-top: 1em;
      }
    </style>
  </head>
  <body>
    <h1>Artikeltrainer Deutsch</h1>

    <div>
      <h2
        id="wortTitel"
        style="
          display: inline;
          cursor: pointer;
          color: blue;
          text-decoration: underline;
        "
      >
        Wort
      </h2>
      <button id="infoBtn">Info</button>
    </div>

    <div id="buttons">
      <button class="artikelBtn" data-artikel="der">der</button>
      <button class="artikelBtn" data-artikel="die">die</button>
      <button class="artikelBtn" data-artikel="das">das</button>
    </div>

    <div id="ergebnis"></div>

    <button id="nextBtn">Nächstes Wort</button>
    <button id="falschBtn">Falsche Wörter</button>
    <button id="zurueckBtn" style="display: none">Zurück</button>

    <!-- Modal für Info -->
    <div id="modal">
      <div id="modalContent">
        <h3>Beschreibung</h3>
        <p id="beschreibungText"></p>
        <button id="modalCloseBtn">Schließen</button>
      </div>
    </div>

    <!-- Modal für falsche Wörter -->
    <div id="falschModal">
      <div id="falschModalContent">
        <h3>Falsche Wörter üben</h3>
        <div id="falschListe"></div>
        <button id="falschModalCloseBtn">Schließen</button>
      </div>
    </div>

    <script>
      let woerter = [];
      let aktuellesWort = null;
      let falscheWoerter = [];
      // falscheWoerter = [{ wort, artikel, beschreibung, richtigeSerie }]

      let imFalschModus = false;

      const wortTitel = document.getElementById("wortTitel");
      const infoBtn = document.getElementById("infoBtn");
      const buttons = document.querySelectorAll(".artikelBtn");
      const ergebnis = document.getElementById("ergebnis");
      const nextBtn = document.getElementById("nextBtn");
      const falschBtn = document.getElementById("falschBtn");
      const zurueckBtn = document.getElementById("zurueckBtn");

      const modal = document.getElementById("modal");
      const modalCloseBtn = document.getElementById("modalCloseBtn");
      const beschreibungText = document.getElementById("beschreibungText");

      const falschModal = document.getElementById("falschModal");
      const falschListe = document.getElementById("falschListe");
      const falschModalCloseBtn = document.getElementById(
        "falschModalCloseBtn"
      );

      // CSV laden
      async function ladeCSV() {
        const res = await fetch("worter.csv");
        const text = await res.text();
        const lines = text.trim().split("\n");
        woerter = lines.map((line) => {
          const [wort, artikel, beschreibung] = line.split(",");
          return {
            wort: wort.trim(),
            artikel: artikel.trim(),
            beschreibung: beschreibung ? beschreibung.trim() : "",
          };
        });
      }

      // Zufälliges Wort holen
      function getRandomWord(array) {
        if (array.length === 0) return null;
        return array[Math.floor(Math.random() * array.length)];
      }

      function zeigeWort(wortObj) {
        aktuellesWort = wortObj;
        wortTitel.textContent = wortObj.wort;
        ergebnis.textContent = "";
        beschreibungText.textContent = "";
        enableButtons(true);
        clearButtonColors();
      }

      // Buttons aktivieren/deaktivieren
      function enableButtons(enabled) {
        buttons.forEach((b) => (b.disabled = !enabled));
        nextBtn.disabled = !enabled;
        infoBtn.disabled = false; // Info immer aktivierbar
      }

      // Button-Farben zurücksetzen
      function clearButtonColors() {
        buttons.forEach((b) => {
          b.classList.remove("correct", "wrong");
        });
      }

      // Prüfen, ob Wort in falscheWoerter-Liste ist
      function findeFalschesWort(wort) {
        return falscheWoerter.find((w) => w.wort === wort);
      }

      // Antwort prüfen
      function checkAntwort(artikelGewählt) {
        if (!aktuellesWort) return;
        enableButtons(false);

        const richtig = artikelGewählt === aktuellesWort.artikel;

        buttons.forEach((b) => {
          if (b.dataset.artikel === aktuellesWort.artikel) {
            b.classList.add("correct");
          }
          if (
            b.dataset.artikel === artikelGewählt &&
            artikelGewählt !== aktuellesWort.artikel
          ) {
            b.classList.add("wrong");
          }
        });

        ergebnis.textContent = `${aktuellesWort.artikel} ${aktuellesWort.wort}`;

        if (imFalschModus) {
          // Modus: Übe falsche Wörter
          let fw = findeFalschesWort(aktuellesWort.wort);
          if (!fw) {
            // Sollte nicht vorkommen, weil nur falsche Wörter angezeigt werden
            fw = { ...aktuellesWort, richtigeSerie: 0 };
            falscheWoerter.push(fw);
          }
          if (richtig) {
            fw.richtigeSerie = (fw.richtigeSerie || 0) + 1;
            if (fw.richtigeSerie >= 3) {
              // Entferne Wort, wenn 3x richtig hintereinander
              falscheWoerter = falscheWoerter.filter((w) => w.wort !== fw.wort);
            }
          } else {
            fw.richtigeSerie = 0;
          }
        } else {
          // Normalmodus
          if (richtig) {
            // Falls Wort in falscheWoerter-Liste ist, erhöhen wir richtigeSerie
            let fw = findeFalschesWort(aktuellesWort.wort);
            if (fw) {
              fw.richtigeSerie = (fw.richtigeSerie || 0) + 1;
              if (fw.richtigeSerie >= 3) {
                falscheWoerter = falscheWoerter.filter(
                  (w) => w.wort !== fw.wort
                );
              }
            }
          } else {
            // Falsch geraten, füge Wort in falscheWoerter hinzu oder setze richtigeSerie zurück
            let fw = findeFalschesWort(aktuellesWort.wort);
            if (!fw) {
              falscheWoerter.push({ ...aktuellesWort, richtigeSerie: 0 });
            } else {
              fw.richtigeSerie = 0;
            }
          }
        }
      }

      // Nächstes Wort laden
      function naechstesWort() {
        ergebnis.textContent = "";
        clearButtonColors();
        enableButtons(true);

        let quelle = imFalschModus ? falscheWoerter : woerter;
        if (quelle.length === 0) {
          ergebnis.textContent = imFalschModus
            ? "Keine falschen Wörter mehr!"
            : "Keine Wörter vorhanden!";
          aktuellesWort = null;
          wortTitel.textContent = "Fertig!";
          return;
        }

        let neuesWort;
        do {
          neuesWort = getRandomWord(quelle);
        } while (
          neuesWort &&
          aktuellesWort &&
          neuesWort.wort === aktuellesWort.wort &&
          quelle.length > 1
        );

        zeigeWort(neuesWort);
      }

      // Modal öffnen/schließen
      function zeigeModal(text) {
        beschreibungText.textContent = text;
        modal.style.display = "flex";
      }

      function schliesseModal() {
        modal.style.display = "none";
      }

      function zeigeFalschModal() {
        if (falscheWoerter.length === 0) {
          alert("Keine falschen Wörter zum Üben!");
          return;
        }
        imFalschModus = true;
        falschListe.innerHTML = "";
        falschModal.style.display = "flex";
        zurueckBtn.style.display = "inline-block";
        nextBtn.style.display = "none";
        falschBtn.style.display = "none";

        naechstesWort();
      }

      function schliesseFalschModal() {
        falschModal.style.display = "none";
        imFalschModus = false;
        zurueckBtn.style.display = "none";
        nextBtn.style.display = "inline-block";
        falschBtn.style.display = "inline-block";

        naechstesWort();
      }

      // Event-Listener
      buttons.forEach((btn) => {
        btn.addEventListener("click", () => {
          if (btn.disabled) return;
          checkAntwort(btn.dataset.artikel);
        });
      });

      nextBtn.addEventListener("click", () => {
        naechstesWort();
      });

      infoBtn.addEventListener("click", () => {
        if (!aktuellesWort) return;
        zeigeModal(
          aktuellesWort.beschreibung || "Keine Beschreibung vorhanden."
        );
      });

      modalCloseBtn.addEventListener("click", schliesseModal);
      falschBtn.addEventListener("click", zeigeFalschModal);
      falschModalCloseBtn.addEventListener("click", schliesseFalschModal);
      zurueckBtn.addEventListener("click", schliesseFalschModal);

      // Modal Klick außerhalb schließt Modal
      modal.addEventListener("click", (e) => {
        if (e.target === modal) schliesseModal();
      });
      falschModal.addEventListener("click", (e) => {
        if (e.target === falschModal) schliesseFalschModal();
      });

      // Beim Laden CSV laden und erstes Wort zeigen
      window.onload = async () => {
        await ladeCSV();
        naechstesWort();
      };
    </script>
  </body>
</html>
